<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>v8 JavaScript tutorial - Internet Checkpoint</title>
    <link rel="stylesheet" href="../../css/default.css" />
    <link rel="stylesheet" href="../../css/syntax.css" />
  </head>

  <body>
    <header>
      <div class="logo">
        <a href="../../">My Internet Checkpoint</a>
      </div>

      <nav>
        <a href="../../projects/">Projects</a>
        <a href="../../posts/">Blog</a>
        <a href="../../about/">About Me</a>
      </nav>
    </header>

    <main role="main">
      <h1>v8 JavaScript tutorial</h1>
      
      <meta name="author" content="Jonas Haukenes" />  <article>
  <section class="header">
    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#ffd479">
      <path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z"></path>
    </svg>
    January 17, 2025
  </section>
  <section class="time">
    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -1000 960 870" width="20px" fill="#ffd479">
      <path d="m612-292 56-56-148-148v-184h-80v216l172 172ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-400Zm0 320q133 0 226.5-93.5T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160Z"></path>
    </svg>
    55 min read
  </section>
  <section class="info">
    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -1000 900 800" width="20px" fill="#ffd479">
      <path d="m240-160 40-160H120l20-80h160l40-160H180l20-80h160l40-160h80l-40 160h160l40-160h80l-40 160h160l-20 80H660l-40 160h160l-20 80H600l-40 160h-80l40-160H360l-40 160h-80Zm140-240h160l40-160H420l-40 160Z"></path>
    </svg>
     <a title="All pages tagged 'JavaScript'." href="../../tags/JavaScript/" rel="tag">JavaScript</a>, <a title="All pages tagged 'v8'." href="../../tags/v8/" rel="tag">v8</a>, <a title="All pages tagged 'C++'." href="../../tags/C%2B%2B/" rel="tag">C++</a> 
  </section>
  <section><h3 id="ecmascript">ECMAScript®</h3>
<p>JavaScript™ is standardized by ECMAScript® and specified in the <a href="https://ecma-international.org/publications-and-standards/standards/ecma-262/">ECMA-262 language specification</a>, which is maintained by Ecma International’s <a href="https://tc39.es/">TC39 committee</a>. ECMAScript® defines the core features of the language, providing a standard that ensures consistency across different JavaScript™ engines. Major engines like <a href="https://v8.dev/">V8</a> (used in Chrome and Node.js), <a href="https://developer.apple.com/documentation/javascriptcore">JavaScriptCore</a> (Safari), and <a href="https://spidermonkey.dev/">SpiderMonkey</a> (Firefox) implement these specifications, allowing developers to write code that behaves similarly across different environments.</p>
<p>V8, the open source, high-performance enginge developed by google which powers JavaScript™ execution in browsers based on chromium, and the runtime environment node.js.
This tutorial focuses on working within v8 to implement and test an ECMAScript® proposal, providing insight into both the ECMAScript® standardization process and the inner workings of a JavaScript™ browser engine.</p>
<h3 id="introduction">Introduction</h3>
<p>Welcome to this detailed tutorial on how to implement and understand the <a href="https://github.com/tc39/proposal-upsert"><code>Map.prototype.upsert</code></a> proposal. This tutorial is tailored to help both beginners and advanced developers learn how to contribute to JavaScript™ language development by implementing a new feature in v8 - Google’s JavaScript™ engine. We will cover all the necessary steps, from downloading and setting up the development environment to specifying and implementing the <code>upsert</code> method and testing it with the official test suite, <a href="https://github.com/tc39/test262">Test262</a>.</p>
<p>We’ll start with an introduction to the <code>Map.prototype.upsert</code> proposal, highlighting its benefits for developers. From there, you’ll be guided through setting up the development environment using the v8 engine. You’ll then implement the <code>upsert</code> method using both <a href="https://v8.dev/docs/torque">torque</a> and (a little bit of) C++, ensuring alignment with the ECMAScript® specification. Afterwards, we will move more and more of the logic to C++ to better match with the actual implementation currently in v8.</p>
<p>The main focus will initially be on developing a functional solution. Once basic functionality is working, optimization techniques will be applied to ensure your code is efficient and performant. You’ll also gain insight into contributing to the ECMAScript® standard, aligning your code with the best practises in the JavaScript™ evolution. Finally, you’ll explore testing with <a href="https://github.com/tc39/test262">Test262</a>, the official ECMAScript® test suite, learning how to write custom tests to validate your implementation.</p>
<p>By the end of this tutorial, you’ll have implemented a fully functional <code>upsert</code> method and gained an understanding into the process of designing, testing and standardizing JavaScript™ features.</p>
<p><strong>Note on the implementation language.</strong><br />
As this tutorial is meant as a guide on implementing features in v8, we will do some extra work to use torque in the implementation, even though the actual implemention is written completely in <a href="https://v8.dev/blog/csa">CSA</a>.</p>
<h3 id="authors">Authors</h3>
<p>This tutorial has mainly been written and edited by: <strong>Jonas Haukenes</strong> with editorial help from <strong>Mikhail Barash</strong>, and is a result of a project conducted at the University of Bergen (Norway) in collaboration with <strong>Daniel Minor</strong> (Mozilla) during August - November 2024.
Parts of this tutorial that is not specific to v8 has been reused from an equivalent tutorial written for SpiderMonkey, which was written and edited by: <strong>Lauritz Thoresen Angeltveit</strong>, <strong>Jonas Haukenes</strong>, <strong>Vetle Larsen</strong>, <strong>Sune Lianes</strong>, <strong>Mathias Hop Ness</strong>, and <strong>Mikhail Barash</strong>.<br />
The project had two goals, the first one was to create tutorials on implementing ECMAScript® proposals in different JavaScript™ engines, the second was too look at implemention work both with and without a mentor’s support. This tutorial is part of the study done without a mentor’s support.</p>
<p>Project supervisors: <strong>Daniel Minor</strong> (Mozilla), <strong>Mikhail Barash</strong> (University of Bergen, Norway).
Project facilitators: <strong>Yulia Startsev</strong> (Mozilla), <strong>Mikhail Barash</strong> (University of Bergen, Norway).</p>
<p>This tutorial can be cited as:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>L<span class="op">.</span> Angeltveit<span class="op">,</span> J<span class="op">.</span> Haukenes<span class="op">,</span> V<span class="op">.</span> Larsen<span class="op">,</span> S<span class="op">.</span> Lianes<span class="op">,</span> M<span class="op">.</span> Ness<span class="op">,</span> M<span class="op">.</span> Barash<span class="op">.</span> Implementing a JavaScript API proposal <span class="er">`</span>Map<span class="op">.</span>prototype<span class="op">.</span>upsert<span class="er">`</span> in v8 <span class="op">(</span>a tutorial<span class="op">).</span> <span class="fl">2025.</span></span></code></pre></div>
<h3 id="what-is-covered-in-this-tutorial">What Is Covered in This Tutorial?</h3>
<ul>
<li><strong>The <code>Map.prototype.upsert</code> Proposal:</strong> Learn what <a href="https://github.com/tc39/proposal-upsert">this proposal</a> is, how it works, and why it’s beneficial for JavaScript™ developers.</li>
<li><strong>Setting up the development environment:</strong> How to download and build <a href="https://hg.mozilla.org/mozilla-unified/"><em>Mozilla Unified</em></a>, the repository that contains SpiderMonkey.</li>
<li><strong>Implementing the proposal:</strong> We will implement the <code>upsert</code> method both in <a href="https://v8.dev/docs/torque">torque</a> and C++.</li>
<li><strong>Debugging and testing:</strong> How to test your implementation using <a href="https://github.com/tc39/test262%22">Test262</a>, the official test suite for ECMAScript®.</li>
<li><strong>Optimizing the code:</strong> Learn about performance considerations and optimizations.</li>
<li><strong>Contributing to the ECMAScript® Specification:</strong> Understand how to write <a href="https://tc39.es/proposal-upsert/">specification</a>-compliant code and contribute to the broader <a href="https://262.ecma-international.org/">ECMAScript® standard</a>.</li>
</ul>
<details open>
<summary class="h2">
The <code>Map.prototype.upsert</code> proposal
</summary>
<p><strong>What is it?</strong></p>
<p><code>Map.prototype.upsert</code> is a new method for <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map"><code>Map</code>-object</a> in JavaScript™. The operation simplifies the process of inserting or updating key-value pairs in the <code>Map</code>: it checks for existence of a key and then either <code>insert</code>s or <code>update</code>s a key-value pair.</p>
<p>This proposal is also intended for <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap"><code>WeakMap</code></a>, which shares a similar API structure. The behavior of <code>upsert</code> in <code>WeakMap</code> would follow the same principles, with the primary difference being the behavior of keys in <code>WeakMap</code>, as they are held weakly and can be garbage collected when no other references to them exist. In this tutorial however, we will focus on the <code>Map</code>-implementation.</p>
<p><strong>How does it work?</strong>
The <code>upsert</code> operation takes two arguments: a <code>key</code> and a <code>handler</code> object. The <code>handler</code> contains two properties:</p>
<ul>
<li><p><code>update</code>: A function to modify <code>value</code> of a <code>key</code> if it is already present in the <code>Map</code>.</p></li>
<li><p><code>insert</code>: A function that generates a <code>default-value</code> to be set to the belonging <code>value</code> of the checked <code>key</code>.</p>
<p><strong>The function <code>upsert</code> operates following these steps:</strong></p>
<ol type="1">
<li>The <code>Map</code> is checked for the <code>key</code> passed as argument. If found:
<ul>
<li>It checks the <code>handler</code> for an <code>update</code> function. If found, this is used to <code>update</code> the <code>value</code> belonging to the passed <code>key</code>. After this, the newly updated entry will be returned.</li>
</ul></li>
<li>If not found, the <code>insert</code> function from the <code>handler</code> is used to generate a new <code>value</code>. This will be assigned to the given <code>key</code> before returning it.</li>
<li>In either case, the <code>value</code> will be the return value of the <code>upsert</code> method.</li>
</ol>
<p><strong>What is the motivation?</strong> Adding and updating values of a <code>Map</code> are oftentimes performed in conjunction. Currently, there are no <code>Map</code> methods for either of these two actions - let alone a method that would do both. Usual workarounds involve multiple lookups and can be inconvenient for developers, and lead to confusing and error-prone code. Introducing a new method <code>upsert</code> shall resolve these drawbacks.</p></li>
</ul>
<h4 id="examples">Examples</h4>
<details>
<summary>
Example: <i>Either updating or inserting for a specific key</i>
</summary>
<ul>
<li>Without using the <code>upsert</code> function:</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// two lookups</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>old <span class="op">=</span> map<span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>old) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  map<span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  map<span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>Using the <code>upsert</code> function:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>map<span class="op">.</span><span class="fu">upsert</span>(key<span class="op">,</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">update</span><span class="op">:</span> () <span class="kw">=&gt;</span> updated<span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">insert</span><span class="op">:</span> () <span class="kw">=&gt;</span> value<span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</details>
<details>
<summary>
Example: <i>Inserting if missing</i>
</summary>
<ul>
<li>Without using the <code>upsert</code> function:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// two lookups</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>map1<span class="op">.</span><span class="fu">has</span>(key)) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  map1<span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>Using the <code>upsert</code> function:</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>map<span class="op">.</span><span class="fu">upsert</span>(key<span class="op">,</span> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">insert</span><span class="op">:</span> () <span class="kw">=&gt;</span> value<span class="op">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</details>
<details>
<summary>
Example: <i>Updating if present</i>
</summary>
<ul>
<li>Without using the <code>upsert</code> function:</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// three lookups</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (map<span class="op">.</span><span class="fu">has</span>(key)) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  old <span class="op">=</span> map<span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  updated <span class="op">=</span> old<span class="op">.</span><span class="fu">doThing</span>()<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  map<span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>Using the <code>upsert</code> function:</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>map<span class="op">.</span><span class="fu">upsert</span>(key<span class="op">,</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">update</span><span class="op">:</span> (old) <span class="kw">=&gt;</span> old<span class="op">.</span><span class="fu">doThing</span>()<span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</details>
</details>
<details open>
<summary class="h1">
Installing v8
</summary>
<p>In this section you will get a brief overview of checking out, building and running the V8-engine.
Please refer to the official guide hostet at V8 pages for more information.</p>
<h2 id="checking-out-and-building">1 Checking out and building</h2>
<h3 id="checking-out-the-source-code">Checking out the source code</h3>
<p>We will start by checking out the v8 source code.
Before we start installing, open a terminal and navigate to the desired location of the v8 folder.</p>
<p>To check out the V8 source code, follow the steps explained in <code>Instructions</code> :</p>
<ul>
<li><a href="https://v8.dev/docs/source-code#instructions">Checking out the V8 source code</a></li>
</ul>
<p>The guide will tell you to make a folder named <code>v8</code>.<br />
Since we will only be working with a single version of v8, we recommend you skip this step as the final folder structure will end up as <code>~/v8/v8/</code>.</p>
<h3 id="installing-build-dependencies">Installing build dependencies</h3>
<p>Now that we have checked out the source code, it is time to install the build dependencies and build v8.</p>
<p>A guide to installing the build dependencies can be found here:</p>
<ul>
<li><a href="https://v8.dev/docs/build#installing-build-dependencies">Installing build dependencies</a></li>
</ul>
<p>/<strong>NB! Linux users:</strong> Currently the script to install build dependencies is only configured to work on with the <code>apt</code> package-manager.</p>
<h3 id="building-v8">Building v8</h3>
<p>To make it easier to build, the v8 dev team has predefined some known configurations:</p>
<ul>
<li><code>x64.release</code> If you are on an x86 machine.</li>
<li><code>arm64.release</code> If you are on an arm machine.</li>
</ul>
<p>There are also other versions like <code>x64.debug</code> and <code>arm64.debug</code>, but one of the ones above will be enough for our use case.<br />
A guide to the build process can be found on:</p>
<ul>
<li><a href="https://v8.dev/docs/build-gn">Building V8 from source</a></li>
</ul>
<p>A more in depth guide to the build process can also be found at:</p>
<ul>
<li><a href="https://v8.dev/docs/build">Building V8 with GN</a></li>
</ul>
<h2 id="running-v8">2 Running V8</h2>
<p>After you have checked out and built v8, you can take it for test drive by running the command:</p>
<pre class="shell"><code>./out/x64.release/d8</code></pre>
<p>Here <code>x64.release</code> is the version name you chose to build.</p>
</details>
<details open>
<summary class="h2">
Chromium code search
</summary>
<p><a href="https://source.chromium.org/chromium/chromium/src">Chromium Code Search</a> is a helpful tool. Chromium Code Search provides an indexed view of the source code, allowing one to efficiently search for specific files, functions, or keywords. For instance, you can trace the implementation of existing JavaScript™ features, see how certain functions interact with v8’s internal data structures, or find how built-in JavaScript™ objects like <code>Map</code> are handled. Chromium Code Search helps you navigate a seemingly endless and confusing codebase.</p>
<p>When implementing the <code>upsert</code> proposal, you will find that looking at existing implementations of similar functionality is often a good starting point. Combine the ECMA-262 Specification with Chromium Code Search and look at existing code.</p>
<p>Example of workflow when trying to implement a line of the specification:</p>
<ol type="1">
<li>Some line from the specification*.</li>
<li>Find some other function with the same or similar specificatin line in the ECMA-262 Specification.</li>
<li>Look up that other function in Chromium Code Search.</li>
<li>Borrow code from that other function’s implementation.</li>
</ol>
</details>
<details open>
<summary class="h2">
v8 API Reference Guide
</summary>
<p><a href="https://v8.github.io/api/head/">v8 API Reference Guide</a>.
As the filestructure of the v8 codebase is enormous, finding how to navigate and understand how the different parts interact with each other can be extremely challenging.
The API Reference Guide is therefore an extremely helpful tool in understanding the relationship between Namespaces, Classes, Files and more.
Therefore, when you are implementing a featue, it can be helpful to look at the relationships and also what functions that should be available to you.</p>
</details>
<details open>
<summary class="h1">
How to Read the ECMA-262 Language Specification
</summary>
<h3 id="what-is-the-ecma-262-specification">1. What is the ECMA-262 Specification?</h3>
<ul>
<li><a href="https://262.ecma-international.org/">ECMA-262</a> is the official document that defines the programming language ECMAScript® (also known as JavaScript™). It provides detailed guidelines for developers and browser vendors on how JavaScript™ should behave in every situation, ensuring consistency and compatibility across different platforms and implementations.</li>
</ul>
<h3 id="how-to-navigate-the-document">2. How to Navigate the Document</h3>
<ul>
<li><strong>Start with the <em>Table of Contents</em></strong>: This is where you’ll find major sections describing the language’s grammar and constructs, data types, standard library functions, and so on. It helps you jump to the part you’re interested in.</li>
<li><strong>Use <em>Search</em></strong>: The specification is a large document. If you’re looking for a specific topic, like <code>Promise</code> or <code>Array</code>, use your browser’s search function (<code>Ctrl + F</code>/<code>cmd + F</code>) to find it quickly.</li>
<li><strong>Annexes (Extras)</strong>: At the end of the document, you’ll find extra sections that explain older features or give additional context.</li>
</ul>
<h3 id="how-to-read-the-algorithms">3. How to Read the Algorithms</h3>
<ul>
<li><strong>Algorithms are like instructions</strong>: The specification breaks down how JavaScript™ works using <a href="https://262.ecma-international.org/#sec-algorithm-conventions">step-by-step instructions</a>, almost like a recipe.</li>
<li><strong>Steps to follow</strong>: The specification breaks down methods like <a href="https://262.ecma-international.org/15.0/#sec-array.prototype.push"><code>Array.prototype.push</code></a> into clear, numbered steps. For instance, it describes how the method first checks the current <code>length</code>, then adds the new element, and finally updates the array’s <code>length</code>.</li>
<li><strong>Conditionals and other control flow constructs</strong>: You’ll often see <code>if</code>-statements, that will tell you how to proceed if the statement evaluates to <code>true</code> or <code>false</code>.</li>
</ul>
<h3 id="some-key-symbols-and-what-they-mean">4. Some Key Symbols and What They Mean</h3>
<ul>
<li><strong><code>[[ ]]</code> (Double Square Brackets)</strong>: These represent <a href="https://262.ecma-international.org/#sec-object-internal-methods-and-internal-slots">internal properties of JavaScript™ objects</a>. These are properties that JavaScript™ uses internally but developers can’t directly access.</li>
<li><strong><code>?</code> (Question Mark)</strong>: This <a href="https://262.ecma-international.org/#sec-returnifabrupt-shorthands">shorthand</a> means “if this operation results in an error (abrupt completion), <code>return</code> that error immediately.” For example, <code>? Call(func, arg)</code> means that if calling <code>func</code> with <code>arg</code> throws an error, stop the current process and <code>return</code> the error right away.</li>
<li><strong><code>Return</code></strong>: This marks the end of an operation, specifying the result to be returned.</li>
<li><strong><code>« »</code> (Guillemets)</strong>: These are used to define <a href="https://tc39.es/ecma262/#sec-list-and-record-specification-type">lists</a> in the specification text. A <strong>List</strong> is an ordered sequence of values, similar to a JavaScript™ array, but used only internally in the specification to represent collections of elements.</li>
<li><strong><code>{ }</code> (Curly braces)</strong>: These are used to define a <a href="https://262.ecma-international.org/#sec-list-and-record-specification-type"><strong>Record</strong></a> structure. A <strong>Record</strong> is a data structure that groups together related fields as <code>key-value</code> pairs. Each field is identified by a name (<code>key</code>) and stores a specific <code>value</code>. These <strong>Record</strong> structures are specification-level entities.</li>
<li><strong>Keywords in Algorithm Specifications</strong>: Keywords like <code>If</code>, <code>Else</code>, or <code>Else if</code> are represented as <strong>algorithmic steps</strong> in plain text, rather than in code syntax, to describe the behavior that an implementation should follow.</li>
</ul>
<h3 id="finding-information-on-other-symbols">5. Finding Information on Other Symbols</h3>
<p>The specification text uses a range of notations and symbols to describe its syntax and structure. To understand these symbols, you can look into section <a href="https://262.ecma-international.org/15.0/#sec-notational-conventions">Notational Conventions</a>. This section explains different types of symbols, and how they are used to define the language.</p>
<p>For example, in section <a href="https://262.ecma-international.org/15.0/#sec-nonterminal-symbols-and-productions">Nonterminal Symbols and Productions</a>, you can read about nonterminal symbols, which are shown in <em>italic font</em>, and learn how to read syntactic definition of a <strong><code>WhileStatement</code></strong> or an <strong><code>ArgumentList</code></strong>.</p>
<h3 id="start-simple">6. Start Simple</h3>
<ul>
<li>Avoid diving into the complex parts right away.</li>
<li>Proceed with sections that describe common JavaScript™ features, such as <a href="https://262.ecma-international.org/15.0/#sec-array-objects">arrays</a> and <a href="https://262.ecma-international.org/15.0/#sec-function-objects">function objects</a>.</li>
<li><strong>External Help</strong>: Use resources like <a href="https://source.chromium.org/chromium/chromium/src">Chromium Code Search</a> to browse and search for JavaScript™ engine implementations or additional explanations before checking the more technical spec.</li>
<li>You can also check out <a href="https://timothygu.me/es-howto/"><em>“How to Read the ECMAScript Specification”</em></a> or <a href="https://v8.dev/blog/tags/understanding-ecmascript"><em>“Understanding ECMAScript”</em></a>: these are helpful guides on how to read the ECMA-262 Language Specification.</li>
</ul>
<h3 id="example-understanding-array.prototype.push">7. Example: Understanding <a href="https://262.ecma-international.org/15.0/#sec-array.prototype.push"><code>Array.prototype.push</code></a></h3>
<p>In the specification, you can search for <code>Array.prototype.push</code> to see how it works. The algorithm will explain that:</p>
<ul>
<li>first, the <code>length</code> of the array is checked</li>
<li>then, the new element is added to the array</li>
<li>finally, the <code>length</code> property is updated to reflect the added element.</li>
</ul>
<h2 id="the-map.prototype.upsert-specification">The <code>Map.prototype.upsert</code> Specification</h2>
<p>This is the specification of the <code>Map.prototype.upsert</code> which will be implemented in this tutorial. This specification will guide our implementation, detailing each operation the <code>upsert</code> method needs to perform to insert or update a <code>key-value</code> pair in a <code>Map</code> object.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1.</span> <span class="va">Let</span> <span class="cn">M</span> <span class="va">be</span> <span class="va">the</span> <span class="va">this</span> <span class="va">value</span><span class="op">.</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3.</span> <span class="va">Let</span> <span class="va">entries</span> <span class="va">be</span> <span class="va">the</span> <span class="va">List</span> <span class="va">that</span> <span class="va">is</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">e</span> <span class="va">that</span> <span class="va">is</span> <span class="va">an</span> <span class="va">element</span> <span class="va">of</span> <span class="va">entries</span><span class="op">,</span> <span class="cf">do</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span><span class="er">a</span><span class="op">.</span> <span class="va">If</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Key]]</span> <span class="va">is</span> <span class="kw">not</span> <span class="va">empty</span> <span class="kw">and</span> SameValueZero<span class="op">(</span><span class="va">e</span><span class="op">.</span><span class="vs">[[Key]]</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">return</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span><span class="er">ai</span><span class="op">.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">)</span> <span class="va">is</span> `<span class="va">true</span>`<span class="op">,</span> <span class="cf">then</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="dv">4</span><span class="er">ai1</span><span class="op">.</span> <span class="va">Let</span> <span class="va">updateFn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">).</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="dv">4</span><span class="er">ai2</span><span class="op">.</span> <span class="va">Let</span> <span class="va">updated</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">updateFn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="dv">4</span><span class="er">ai3</span><span class="op">.</span> <span class="va">Set</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span> <span class="va">to</span> <span class="va">updated</span><span class="op">.</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span><span class="er">aii</span><span class="op">.</span> <span class="va">Return</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5.</span> <span class="va">Let</span> <span class="va">insertFn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">).</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6.</span> <span class="va">Let</span> <span class="va">inserted</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">insertFn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7.</span> <span class="va">Set</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span> <span class="va">to</span> <span class="va">inserted</span><span class="op">.</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="dv">8.</span> <span class="va">Return</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span></code></pre></div>
<p>An HTML version of the specification can be found <a href="https://bldl.github.io/upsert-tutorial/initial-emplace-spec/Map.prototype.emplace.html">here</a>.</p>
<p>The ECMA-262 Specification text can look intimidating at first glance. Before starting the implementation, try to get a rough understanding of what each line in the specification means. Write pseudocode, natural language sentences or a combination of them, for yourself to understand what is actually going on.
The aim is to develop a clear understanding of the functionality we want to achieve.</p>
<p><strong>Key Points to Focus On:</strong></p>
<ul>
<li><strong>Scope and Validation:</strong> The first few lines establish the <code>this value</code> (<code>M</code>) and ensure it’s a valid instance of <code>Map</code>.</li>
<li><strong>Iterating Over Entries:</strong> The method iterates through the <code>Map</code> entries to check if the specified <code>key</code> already exists.</li>
<li><strong>Conditional Update or Insert:</strong> If the key exists, it checks for an <code>update</code> function in the <code>handler</code> and applies it to update the <code>value</code>. If the key does not exist, it uses the <code>insert</code> function to create a new entry.</li>
<li><strong>Returning the Result:</strong> Finally, it returns the updated or inserted <code>value</code>.</li>
</ul>
<p>By breaking down the specification in this way, you’ll have a roadmap for implementing each part of the <code>upsert</code> method. This approach will help make the implementation process smoother and ensure that you understand how each step contributes to the overall functionality.</p>
<p><strong>Rewrite the Specification in Your Own Words</strong></p>
<p>Example:</p>
<ol type="1">
<li>Let <strong>entries</strong> be the <code>List</code> that is <strong>M</strong>.[[MapData]].</li>
</ol>
<p>Could be rewritten to:</p>
<ol type="1">
<li>Make a <code>List</code> variable <strong>entries</strong>, which stores pairs <code>(key, value)</code>.</li>
</ol>
<p>In the implementation part of this tutorial, each line of the specification will be explained.</p>
</details>
<details open>
<summary class="h1">
Implementation
</summary>
<p>All paths in this tutorial is given as relative paths from the base folder of v8 that was created in the installation.</p>
<h2 id="creating-a-file">Creating a file</h2>
<p>The organization of JavaScript functions in v8 is done by letting each function that is callable from JavaScript have its own torque file in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/;drc=89dbb5d0b0922ddbdf7c87ca205e1c703aa67b24"><code>src/builtins</code></a> folder.
Therefore, we start of the implementation by creating the file, <code>map-upsert.tq</code> in this folder.
We then need to declare the file in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/BUILD.gn;l=1964;drc=cf9e3f5c748b90fb14fb41864567577b84abd049"><code>BUILD.gn</code></a> file. To declare it, we just need to give the relative path to the file.</p>
<pre><code>&quot;src/builtins/iterator-helpers.tq&quot;,
&quot;src/builtins/map-groupby.tq&quot;,
&quot;src/builtins/map-upsert.tq&quot;,
&quot;src/builtins/math.tq&quot;,
&quot;src/builtins/number.tq&quot;,</code></pre>
<h2 id="creating-a-function">Creating a function</h2>
<p>After we have created the file and declared it, we can now create a function and hook it in <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/init/bootstrapper.cc;l=1;drc=9823ffa568cbb16d70ed19c424382b8373947a5f"><code>bootstrapper.cc</code></a>.</p>
<p>Open up <code>map-upsert.tq</code> and write the following code:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="st">&quot;42&quot;</span><span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As we are not using the variables <code>key</code> or <code>handler</code>, we must put <code>_</code> in front, or we will get a compile error.</p>
<p>Now that we have defined this function, we can hook it in.
All JavaScript functions related to objects are defined in a context that is limited to this specific
object. We will declare our function in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/init/bootstrapper.cc;l=4531;drc=9823ffa568cbb16d70ed19c424382b8373947a5f"><code>// -- M a p</code></a> context.</p>
<p>Include some of the code that is around</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>  <span class="co">// -- M a p</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>SimpleInstallFunction<span class="op">(</span><span class="va">isolate_</span><span class="op">,</span> prototype<span class="op">,</span> <span class="st">&quot;values&quot;</span><span class="op">,</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                      Builtin<span class="op">::</span>kMapPrototypeValues<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> kAdapt<span class="op">);</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>SimpleInstallFunction<span class="op">(</span><span class="va">isolate_</span><span class="op">,</span> prototype<span class="op">,</span> <span class="st">&quot;upsert&quot;</span><span class="op">,</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                      Builtin<span class="op">::</span>kMapPrototypeUpsert<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> kAdapt<span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>native_context<span class="op">()-&gt;</span>set_initial_map_prototype_map<span class="op">(</span>prototype<span class="op">-&gt;</span>map<span class="op">());</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>These lines sets up the hook with the following details:</p>
<ul>
<li><strong>SimpleInstallFunction:</strong> This function is used to define/install functions that should be callable from JavaScript.</li>
<li><strong>First argument:</strong> Specifies if the function should be isolated to only one thread. There are very few instances where the function should not be isolated.</li>
<li><strong>Second argument:</strong> Specifies what kind of function we have. Is it a standalone function such as <code>groupBy</code> or is it connected to a object.</li>
<li><strong>Third argument:</strong> Specifies the JavaScript name of the function.</li>
<li><strong>Fourth argument:</strong> Specifies the name of the function in the <code>v8</code> that is called from JavaScript. the <code>k</code> added at the start of the name is not an actuall part of the function declaration in v8.</li>
<li><strong>Fifth argument:</strong> Specifies the number of arguments the function should take.</li>
<li><strong>Sixth argument:</strong> Specifies if the function should adapt to the number of arguments that are passed. The <code>kAdapt</code> is the most used one, and <code>kDontAdapt</code> is used if you have optional arguments which means that the arguments might be altered while passing. For example <code>Map.forEach</code> which have two optional arguments.</li>
</ul>
<p>We can test our function in the shell with:</p>
<pre class="shell"><code>gm x64.release
...
out/x64.release/d8</code></pre>
<p>Once the shell opens, we can test the <code>upsert</code> function, the output should look something like this:</p>
<pre class="shell"><code>d8&gt; var map = new Map()
undefined
d8&gt; map.upsert(0, 0)
&quot;42&quot;</code></pre>
<h2 id="step-1-2---implement-the-first-two-lines">Step 1 &amp; 2 - Implement The First Two Lines</h2>
<p>For the first part of the specificaiton, we will actually combine the first two
lines.</p>
<h3 id="specification-lines">Specification Lines</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1.</span> <span class="va">Let</span> <span class="cn">M</span> <span class="va">be</span> <span class="va">the</span> <span class="va">this</span> <span class="va">value</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span></code></pre></div>
<p>In v8, the <code>this</code> value will be provided by the receiver argument that is passed as an argument.
Line number two is handled by casting the object to the right type, if the object is incompatible with the cast type, this casting will fail and we throw an error.</p>
<p>In the code we implement these two values by simply casting <code>receiver</code> to
a <code>JSMap</code> and providing a Throw message.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-3---namespaces">Step 3 - Namespaces</h2>
<p>As the next line requires us to access the internal data of our map object, we will have to have a look around to see how we can do this.</p>
<p>Usually we would look at how, other functions written the same type of objects does not. But since we don’t have any usefull examples of <code>JSMap</code> functions written in torque that we can follow, we will instead loook at the union functions for set.</p>
<p>Here you will find some functions that looks usefull and which we will explain later, but notice that these functions are declared in the <code>collections</code> namespace. We will therefore start of by putting our function inside this namespace.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can now look in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/collections.tq;drc=7cfde062fc4deb00d3894cb16346f21dd510e7aa"><code>collections.tq</code></a> file to see what functions we have available.<br />
Usually we will find functions that are commonly used being declared here, but some useful functions might be declared inside this namespace in another file.</p>
<p>Therefore, you might have to take a look around other functions that are declared inside this namespace but in other files to see if something has already been declared. It is therefore recommended using something like <a href="https://source.chromium.org/chromium/chromium/src">Chromium Code Search</a> for this, and we will actually discover this with the function <code>NormalizeNumberKey</code> that we will use later.</p>
<p>Moving on with the implementation.</p>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dv">3.</span> <span class="va">Let</span> <span class="va">entries</span> <span class="va">be</span> <span class="va">the</span> <span class="va">List</span> <span class="va">that</span> <span class="va">is</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">.</span></span></code></pre></div>
<p>To be able to get the entries for our table. we must do two steps.<br />
First, get a NewStableBackingTableWitness<br />
Second, use that table to get an iterator that we can iterate over.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-4---iterating-through-the-map-entries">Step 4 - Iterating through the map entries</h2>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">e</span> <span class="va">that</span> <span class="va">is</span> <span class="va">an</span> <span class="va">element</span> <span class="va">of</span> <span class="va">entries</span><span class="op">,</span> <span class="cf">do</span></span></code></pre></div>
<p>As of the writing of this tutorial, torque only supports normal for-loops, not for-each-loops.
We will iterate over the values using a <code>while-loop</code>, but as iterator doesn’t something like a <code>hasNext</code> function, we will instead make use of a <code>try-block</code> with a label for where to go when the call to <code>next</code> fails.</p>
<p><strong>While-iterator</strong></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>For-each-iterator</strong><br />
We can also acomplish this using a <code>for-loop</code>, but it is not preffered and is mostly just a funny way of doing it.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;;</span>e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done) {</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-4.a---check-if-the-key-already-exists">Step 4.a - Check if the <code>key</code> already exists</h2>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span><span class="er">a</span><span class="op">.</span> <span class="va">If</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Key]]</span> <span class="va">is</span> <span class="kw">not</span> <span class="va">empty</span> <span class="kw">and</span> SameValueZero<span class="op">(</span><span class="va">e</span><span class="op">.</span><span class="vs">[[Key]]</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span></code></pre></div>
<p>As the key comparison requires <code>SameValueZero</code>, we will need to normalize <code>0</code> values.<br />
This means that <span class="math inline">−0 = 0 = +0</span>.
To do this, we will use the <code>NormalizeNumberKey</code> function. This function is defined in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-collections-gen.cc;l=1631;drc=1900c13398549f2923fe0f4822c6d695f77af4c6"><code>src/builtins/builtins-collections-gen.cc</code></a> file.
Commonly used functions should be declared in the relevant namespace file, in this case it would be <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/collections.tq;drc=2312ab9b8999fa3580d4567773f9a1abb894d8c7"><code>src/builtins/collections.tq</code></a>, but they might also be declared elsewhere. So when looking for relevant functions, you should also look in other functions that might be using the same namespace or search for it using <a href="https://source.chromium.org/chromium/chromium/src">Chromium Code Search</a>.
When doing this we find that <code>NormalizeNumberKey</code> is declared in the <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/object-groupby.tq;l=11;drc=2312ab9b8999fa3580d4567773f9a1abb894d8c7"><code>src/builtins/object-groupby.tq</code></a> file.</p>
<p>But if it wasn’t declared beforehand, we could have declared it ourself with the following:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>extern macro CollectionsBuiltinsAssembler<span class="op">::</span><span class="fu">NormalizeNumberKey</span>(JSAny)<span class="op">:</span> JSAny<span class="op">;</span></span></code></pre></div>
<ul>
<li><strong>extern:</strong> Specifies that the function is declared outside of torque, usually in some <code>.cc</code> file.</li>
<li><strong>macro:</strong> Specifies that the function corresponds to a chunk of generated CSA-producing C++ (simply, some hand-written C++ CSA code).</li>
<li><strong>CollectionsBuiltinsAssembler:</strong> Specifies the class the function is in. This is only used when we are declaring <code>extern</code> macros so the compiler knows where to look for the function.</li>
<li><strong>NormalizeNumberKey:</strong> <code>IdentifierName</code> of the function.</li>
<li><strong>JSAny:</strong> The second set of parenthesis is the explicit parameters. Here we just specify the type of the arguments that we pass explicitly.</li>
<li><strong>JSAny:</strong> Specifies the return type of the function.</li>
</ul>
<p>As the <code>NormalizeNumberKey</code> function doesn’t need the context to execute, we don’t send this along. However, if the function need context that is passed implcitly, we would have need to add another set of parameters in the same way we already did for <code>MapPrototypeUpsert</code>.</p>
<p>To do comparisons, we would usually use <code>==</code> if we know that the types of what we are comparing are the same. The <code>==</code> is actually just an <code>overloaded</code> <code>extern</code> <code>operator</code>, and all overloads of this can be found in <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/base.tq;drc=ef75832f2e34705d9794e5b8a16cdd266135f7c8"><code>src/builtins/base.tq</code></a>.
Since we can’t guarantee the object identity is the right equality, we will instead use the <code>TaggedEqual</code> function directly as that will be able to use it with the <code>MaybeObject</code> type. This type is also declared in <code>base.tq</code>.
Now we should have everything we need to compare the entry key and the provided key.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-4.a.i---check-the-update-handler">Step 4.a.i - Check the <code>update</code> handler</h2>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span><span class="er">a</span><span class="op">.</span><span class="va">i</span><span class="op">.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">)</span> <span class="va">is</span> `<span class="va">true</span>`<span class="op">,</span> <span class="cf">then</span></span></code></pre></div>
<p>For this line we should verify wheter the handler variable actually contains a field <code>update</code> before we try to access it.
Luckily, the function used to do this is the same as in the specification text and as it is declared in <code>base.tq</code> we can just use it.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    i. If HasProperty(handler, &quot;update&quot;) is `true`, then</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">HasProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>) <span class="op">==</span> True) {</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ...</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-4.a.i.1---get-the-update-function-from-the-handler">Step 4.a.i.1 - Get the <code>update</code> function from the <code>handler</code></h2>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span><span class="er">a</span><span class="op">.</span><span class="va">i</span><span class="dv">.1</span><span class="op">.</span> <span class="va">Let</span> <span class="va">updateFn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">).</span></span></code></pre></div>
<p>If the handler object does contain a update field, we store the value of the<code>update</code> field in the variable <code>updateFn</code>.
There is no <code>Get</code> functions such as it was for <code>HasProperty</code>, but there is a <code>GetProperty</code> function which we will use instead.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    i. If HasProperty(handler, &quot;update&quot;) is `true`, then</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">HasProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>) <span class="op">==</span> True) {</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      1. Let updateFn be ? Get(handler, &quot;update&quot;).</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updateFn <span class="op">=</span> <span class="fu">GetProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>)<span class="op">;</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ...</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="step-4.a.i.2---compute-a-new-value-with-updatefn">Step 4.a.i.2 - Compute a new value with <code>updateFn</code></h2>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span><span class="er">a</span><span class="op">.</span><span class="va">i</span><span class="dv">.2</span><span class="op">.</span> <span class="va">Let</span> <span class="va">updated</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">updateFn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span></code></pre></div>
<p>All the things we have done until now won’t change the layout of the map or the state.
But since we will know execute some arbitrary JavaScript code which might change something, we will have to mark the <code>MapPrototypeUpsert</code> as <a href="https://v8.dev/docs/torque#transient-types"><code>transitioning</code></a> to indicate that the function might do this now.
To do this, simply add the <code>transitioning</code> keyword to the start of the function declaration.</p>
<!-- Since the `transitioning` keyword already specifies that this function, `MapPrototypeUpsert` might change type during execution. Therefore, we just use the `Call` function to compute an updated value. -->
<p>Once we have marked it as <code>transitioning</code> we can now call the <code>updateFn</code>, and store the result in <code>updated</code></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    i. If HasProperty(handler, &quot;update&quot;) is `true`, then</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">HasProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>) <span class="op">==</span> True) {</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      1. Let updateFn be ? Get(handler, &quot;update&quot;).</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updateFn <span class="op">=</span> <span class="fu">GetProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>)<span class="op">;</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      2. Let updated be ? Call(updateFn, handler, « e.[[Value]], key, M »).</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updated <span class="op">=</span> <span class="fu">Call</span>(context<span class="op">,</span> updateFn<span class="op">,</span> handler<span class="op">,</span> e<span class="op">.</span><span class="at">value</span><span class="op">,</span> key<span class="op">,</span> m)<span class="op">;</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ...</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Following is an explanation of the arguments passed to the <code>Call</code> function</p>
<ul>
<li>The first argument is always the context we are executing this function from, <code>context</code>.</li>
<li>The second argument is the function we want to evaluate, <code>updateFn</code>.</li>
<li>The third argument is the <code>this</code> instance that the function is executed with, <code>handler</code>.</li>
<li>The arguments after this are ones that are passed to the function we are evaluating, <code>e.value</code>, <code>key</code> and <code>m</code>.</li>
</ul>
<h2 id="step-4.a.i.3---set-the-new-value-in-the-map">Step 4.a.i.3 - Set the new value in the map</h2>
<p>Once we have computed the updated value, we can move onto setting the value in the map.
<strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span><span class="er">a</span><span class="op">.</span><span class="va">i</span><span class="dv">.3</span><span class="op">.</span> <span class="va">Set</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span> <span class="va">to</span> <span class="va">updated</span><span class="op">.</span></span></code></pre></div>
<p>To do this, we will have to expose a function to torque as the <code>Map.prototype.set</code> function is defined as a <code>TF_BUILTIN</code> in <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-collections-gen.cc;l=1733;drc=ef75832f2e34705d9794e5b8a16cdd266135f7c8"><code>builtins-collections-gen.cc</code></a>, and as far as I am aware, it is not possible to call this function from torque.
To make this a function we can call from torque, we will define a function <code>MapSet</code> in <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/builtins/builtins-collections-gen.cc;l=1733;drc=ef75832f2e34705d9794e5b8a16cdd266135f7c8"><code>builtins-collections-gen.cc</code></a> as follows:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>TNode<span class="op">&lt;</span>JSMap<span class="op">&gt;</span> CollectionsBuiltinsAssembler<span class="op">::</span>MapSet<span class="op">(</span><span class="at">const</span> TNode<span class="op">&lt;</span>Context<span class="op">&gt;</span> context<span class="op">,</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                                                  TNode<span class="op">&lt;</span>JSMap<span class="op">&gt;</span> receiver<span class="op">,</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                                                  TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> key<span class="op">,</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                                                  TNode<span class="op">&lt;</span>Object<span class="op">&gt;</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  key <span class="op">=</span> NormalizeNumberKey<span class="op">(</span>key<span class="op">);</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  GrowCollection<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> grow <span class="op">=</span> <span class="op">[</span><span class="kw">this</span><span class="op">,</span> context<span class="op">,</span> receiver<span class="op">]()</span> <span class="op">{</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    CallRuntime<span class="op">(</span>Runtime<span class="op">::</span>kMapGrow<span class="op">,</span> context<span class="op">,</span> receiver<span class="op">);</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> LoadObjectField<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;(</span>receiver<span class="op">,</span> JSMap<span class="op">::</span>kTableOffset<span class="op">);</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  StoreAtEntry<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> store_at_new_entry <span class="op">=</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">this</span><span class="op">,</span> key<span class="op">,</span> value<span class="op">](</span><span class="at">const</span> TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table<span class="op">,</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> entry_start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        UnsafeStoreKeyValueInOrderedHashMapEntry<span class="op">(</span>table<span class="op">,</span> key<span class="op">,</span> value<span class="op">,</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>                                                 entry_start<span class="op">);</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  StoreAtEntry<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> store_at_existing_entry <span class="op">=</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">this</span><span class="op">,</span> value<span class="op">](</span><span class="at">const</span> TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table<span class="op">,</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>                    <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> entry_start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        UnsafeStoreValueInOrderedHashMapEntry<span class="op">(</span>table<span class="op">,</span> value<span class="op">,</span> entry_start<span class="op">);</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table <span class="op">=</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>      LoadObjectField<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;(</span>receiver<span class="op">,</span> JSMap<span class="op">::</span>kTableOffset<span class="op">);</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  AddToOrderedHashTable<span class="op">(</span>table<span class="op">,</span> key<span class="op">,</span> grow<span class="op">,</span> store_at_new_entry<span class="op">,</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>                        store_at_existing_entry<span class="op">);</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> receiver<span class="op">;</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We will also have to declare this function in the <code>builtins-collections-gen.h</code> as follows:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>TNode<span class="op">&lt;</span>JSMap<span class="op">&gt;</span> MapSet<span class="op">(</span><span class="at">const</span> TNode<span class="op">&lt;</span>Context<span class="op">&gt;</span> context<span class="op">,</span> TNode<span class="op">&lt;</span>JSMap<span class="op">&gt;</span> receiver<span class="op">,</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                    TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> key<span class="op">,</span> TNode<span class="op">&lt;</span>Object<span class="op">&gt;</span> value<span class="op">);</span></span></code></pre></div>
<p>Then, to be ablet to call this function from torque, we will have to declare it as an external macro. We will declare this function in the <code>collections.tq</code> file so it is within the <code>collections</code> namespace.
Take notice that we now use two set of parameters to pass along the context as this is required by the function.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>extern macro CollectionsBuiltinsAssembler<span class="op">::</span><span class="fu">MapSet</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    implicit context<span class="op">:</span> Context)(JSMap<span class="op">,</span> JSAny<span class="op">,</span> <span class="bu">Object</span>)<span class="op">:</span> JSMap<span class="op">;</span></span></code></pre></div>
<p>Now, we can finally write the specification line.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    i. If HasProperty(handler, &quot;update&quot;) is `true`, then</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">HasProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>) <span class="op">==</span> True) {</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      1. Let updateFn be ? Get(handler, &quot;update&quot;).</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updateFn <span class="op">=</span> <span class="fu">GetProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>)<span class="op">;</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      2. Let updated be ? Call(updateFn, handler, « e.[[Value]], key, M »).</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updated <span class="op">=</span> <span class="fu">Call</span>(context<span class="op">,</span> updateFn<span class="op">,</span> handler<span class="op">,</span> e<span class="op">.</span><span class="at">value</span><span class="op">,</span> key<span class="op">,</span> m)<span class="op">;</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      3. Set e.[[Value]] to updated.</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">MapSet</span>(m<span class="op">,</span> key<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This way of making the function available to torque is probably not the prefered way of doing this as we end up with a lot of code duplication, but we have chosen to do it this way for the tutorial to keep it simple.</p>
<h2 id="step-4.a.ii---return-the-new-value">Step 4.a.ii - Return the new value</h2>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span><span class="er">a</span><span class="op">.</span><span class="va">ii</span><span class="op">.</span> <span class="va">Return</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span></code></pre></div>
<p>As we did for <code>MapSet</code>, we will also declare a similar function to get values from the underlying tableStructure.
In <code>builtins-collections-gen.h</code> define the function <code>TableGetValue</code>, then implement it in <code>builtins-collections-gen.cc</code> and finally declare it as an external macro in the <code>collections</code> namespace.</p>
<p><strong>builtins-collections-gen.h:</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> TableGetValue<span class="op">(</span><span class="at">const</span> TNode<span class="op">&lt;</span>Context<span class="op">&gt;</span> context<span class="op">,</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                           TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table<span class="op">,</span> TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> key<span class="op">);</span></span></code></pre></div>
<p><strong>builtins-collections-gen.cc:</strong></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> CollectionsBuiltinsAssembler<span class="op">::</span>TableGetValue<span class="op">(</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>Context<span class="op">&gt;</span> context<span class="op">,</span> TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table<span class="op">,</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  TVARIABLE<span class="op">(</span>Object<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  TNode<span class="op">&lt;</span>Smi<span class="op">&gt;</span> index <span class="op">=</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>      CAST<span class="op">(</span>CallBuiltin<span class="op">(</span>Builtin<span class="op">::</span>kFindOrderedHashMapEntry<span class="op">,</span> context<span class="op">,</span> table<span class="op">,</span> key<span class="op">));</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  Label if_found<span class="op">(</span><span class="kw">this</span><span class="op">),</span> if_not_found<span class="op">(</span><span class="kw">this</span><span class="op">),</span> done<span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  Branch<span class="op">(</span>SmiGreaterThanOrEqual<span class="op">(</span>index<span class="op">,</span> SmiConstant<span class="op">(</span><span class="dv">0</span><span class="op">)),</span> <span class="op">&amp;</span>if_found<span class="op">,</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>         <span class="op">&amp;</span>if_not_found<span class="op">);</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>if_found<span class="op">);</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> LoadValueFromOrderedHashMapEntry<span class="op">(</span>table<span class="op">,</span> SmiUntag<span class="op">(</span>index<span class="op">));</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  Goto<span class="op">(&amp;</span>done<span class="op">);</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>if_not_found<span class="op">);</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> UndefinedConstant<span class="op">();</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  Goto<span class="op">(&amp;</span>done<span class="op">);</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>done<span class="op">);</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> CAST<span class="op">(</span>result<span class="op">.</span>value<span class="op">());</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>External declaration:</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>extern macro CollectionsBuiltinsAssembler<span class="op">::</span><span class="fu">TableGetValue</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    implicit context<span class="op">:</span> Context)(OrderedHashMap<span class="op">,</span> JSAny)<span class="op">:</span> JSAny<span class="op">;</span></span></code></pre></div>
<p>Since the update function might have mutated the map, we cannot use the same table structure as the one we have been iterating over.
We could manually get a updated table as we did before iterating, but we can also create a macro that will do this for us.
To this define the following function under <code>TableGetValue</code> in <code>collections.tq</code>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>macro <span class="fu">GetValue</span>(implicit context<span class="op">:</span> Context)(o<span class="op">:</span> JSMap<span class="op">,</span> key<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> table <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span>(o<span class="op">.</span><span class="at">table</span>) otherwise unreachable<span class="op">;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">TableGetValue</span>(table<span class="op">,</span> key)<span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This function takes in a JSMap object, casts its table to an OrderedHashMap and calls the TableGetValue function.</p>
<p>Then we can write the line</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    i.  If HasProperty(handler, &quot;update&quot;) is `true`, then</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">HasProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>) <span class="op">==</span> True) {</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      1. Let updateFn be ? Get(handler, &quot;update&quot;).</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updateFn <span class="op">=</span> <span class="fu">GetProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>)<span class="op">;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      2. Let updated be ? Call(updateFn, handler, « e.[[Value]], key, M »).</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updated <span class="op">=</span> <span class="fu">Call</span>(context<span class="op">,</span> updateFn<span class="op">,</span> handler<span class="op">,</span> e<span class="op">.</span><span class="at">value</span><span class="op">,</span> key<span class="op">,</span> m)<span class="op">;</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      3. Set e.[[Value]] to updated.</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">MapSet</span>(m<span class="op">,</span> key<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     ii. Return e.[[Value]].</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">GetValue</span>(m<span class="op">,</span> key)<span class="op">;</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="step-5---implementing-the-insert-handler">Step 5 - Implementing The Insert Handler</h3>
<p>As the last four steps is very similar to what is inside the last if-statement, we can do these as one step.
<strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dv">5.</span> <span class="va">Let</span> <span class="va">insertFn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">).</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="dv">6.</span> <span class="va">Let</span> <span class="va">inserted</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">insertFn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="dv">7.</span> <span class="va">Set</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span> <span class="va">to</span> <span class="va">inserted</span><span class="op">.</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="dv">8.</span> <span class="va">Return</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeUpsert</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(_key<span class="op">:</span> JSAny<span class="op">,</span> _handler<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.upsert'</span><span class="op">;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ThrowTypeError</span>(</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>              MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Let entries be the List that is M.[[MapData]].</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> entries <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } e that is an element of entries, do</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> e <span class="op">=</span> entries<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValueZero(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(e<span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="fu">NormalizeNumberKey</span>(key))) {</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    i.  If HasProperty(handler, &quot;update&quot;) is `true`, then</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">HasProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>) <span class="op">==</span> True) {</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      1. Let updateFn be ? Get(handler, &quot;update&quot;).</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updateFn <span class="op">=</span> <span class="fu">GetProperty</span>(handler<span class="op">,</span> <span class="st">&quot;update&quot;</span>)<span class="op">;</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      2. Let updated be ? Call(updateFn, handler, « e.[[Value]], key, M »).</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> updated <span class="op">=</span> <span class="fu">Call</span>(context<span class="op">,</span> updateFn<span class="op">,</span> handler<span class="op">,</span> e<span class="op">.</span><span class="at">value</span><span class="op">,</span> key<span class="op">,</span> m)<span class="op">;</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      3. Set e.[[Value]] to updated.</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">MapSet</span>(m<span class="op">,</span> key<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">//     ii. Return e.[[Value]].</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">GetValue</span>(m<span class="op">,</span> key)<span class="op">;</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 5. Let insertFn be ? Get(handler, &quot;insert&quot;).</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> insertFn <span class="op">=</span> <span class="fu">GetProperty</span>(handler<span class="op">,</span> <span class="st">&quot;insert&quot;</span>)<span class="op">;</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 6. Let inserted be ? Call(insertFn, handler, « e.[[Value]], key, M »).</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> inserted <span class="op">=</span> <span class="fu">Call</span>(context<span class="op">,</span> insertFn<span class="op">,</span> handler<span class="op">,</span> key<span class="op">,</span> m)<span class="op">;</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 7. Set e.[[Value]] to inserted.</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MapSet</span>(m<span class="op">,</span> key<span class="op">,</span> inserted)<span class="op">;</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 8. Return e.[[Value]].</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">GetValue</span>(m<span class="op">,</span> key)<span class="op">;</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="test-the-implementation">Test the Implementation</h3>
<p>Now that we have written our implementation, we can try it out in our terminal.
Build the code and run it in the shell with:</p>
<pre class="shell"><code>gm x64.release
⋮
out/x64.release/d8</code></pre>
<p>Once the shell opens, we can test the upsert function, the output should look something like this:</p>
<pre class="shell"><code>d8&gt; var map = new Map()
undefined
d8&gt; const lTest = {insert(key, map) {return 0;}, update(existing, key, map) {return existing + 1;}};
undefined
d8&gt; map.set(&quot;a&quot;, 1)
[object Map]
d8&gt; map.upsert(&quot;a&quot;, lTest)
2
d8&gt; map.upsert(&quot;a&quot;, lTest)
3
d8&gt; map.upsert(&quot;g&quot;, lTest)
0
d8&gt; map.upsert(&quot;g&quot;, lTest)
1
d8&gt;</code></pre>
</details>
<details open>
<summary class="h1">
Issues With the Original Proposal
</summary>
<p>The proposal we have implemented provides a flexible solution by allowing both an <code>update</code> and an <code>insert</code> function. While flexibility is generally a good thing, here it adds unnecessary complexity to the usage of <code>upsert</code>. In other words, flexibility comes here at the expense of simplicity and ease of use which are very important for widespread adoption in programming languages.</p>
<p>The most likely primary, in-demand use case of the <code>upsert</code> method is when a developer wants to check whether a <code>key</code> exists and, if it doesn’t, to insert it into the map.
That is, most developers typically would just need to insert a <code>value</code> if the given <code>key</code> is missing - rather than providing separate logic for both <code>insert</code> and <code>update</code>.
We can argue that the proposal design in its current form unnecessarily complicates the use of the <code>upsert</code> method for a majority of developers.</p>
<p>Moreover, the current design doesn’t align well with common practices in other major programming languages.
An example with a similar - and simpler - functionality is the <a href="https://docs.python.org/2/library/stdtypes.html#dict.setdefault"><code>setdefault</code></a> method on dictionaries in Python.
Again, we can argue that being an overcomplicated feature not commonly found in other languages, the <code>upsert</code> method is at risk of being underutilized.
Reducing the scope of the proposal, so that it has a more straightforward behaviour, would make it more intuitive and more likely to be used effectively by JavaScript™ developers.</p>
</details>
<details>
<summary class="h2">
Issues with the specification text
</summary>
<p>Even if we ignore these issues, there are also problems with the specification text that makes the behaviour of the function unpredictable. We will through the specification text for <code>Map.prototype.upsert(key, handler)</code> line by line, see if they ensure the intended behaviour that we wish, follow other similar specifications and at the end rewrite the proposal.</p>
<h4 id="step-1-2">Step 1-2</h4>
<p>The two first lines of the proposal is fine as they are. These lines allows us the verify that the function isn’t called on objects that aren’t maps.</p>
<h4 id="step-3">Step 3</h4>
<p>When comparing this line against the ones found in other specifications such as <code>Map.prototype.set</code> we see that this line is unneeded as we can incorporate it in the next line. The line most likely comes about as this is how one would implement it in <code>v8</code>.</p>
<h4 id="step-4">Step 4</h4>
<p>As mentioned above, we can rewrite this line to incorporate line 3. We can also change the variable name from <code>e</code> to <code>p</code> to make it consistent with similar specifications.</p>
<h4 id="step-4.a">Step 4.a</h4>
<p>The first half of this line <code>If e.[[Key]] is not empty and</code> is fine, but to compare the keys we make a call to <code>SameValueZero</code>. This is not incorrect, but the <code>SameValueZero</code> function will on each call normalize the keys <span class="math inline">(−0 = 0 = +0)</span> before doing the comparisons. This can be avoided if we normalize the input key before entering the for-loop, since all the keys that are already in the map will be normalized.
And if we look at a similar specification, this is exactly what they do.</p>
<h4 id="step-4.a.i">Step 4.a.i</h4>
<p>As the <code>update</code> property should be optional, this step is needed. However, since this is a user provided function, we need to make sure that it is <code>callable</code> before we try to use it and if it isn’t callable we should throw an error.
But if we just another if-statement after this one, the behaviour of our function could become unpredictable as if the <code>update</code> function is not callable, the function could sometimes throw an error and other times not all depending on if the key is already in the map or not. Therefore we will have to move this verification to before the for-loop.</p>
<h4 id="step-4.a.i.1-4.a.i.3">Step 4.a.i.1-4.a.i.3</h4>
<p>The intent behind these lines is fine, and they only need some rewriting to make them consistent with other proposals.</p>
<h4 id="step-4.a.ii">Step 4.a.ii</h4>
<p>This line can be kept as it is. But it also highlights the fact that we can’t remove the
<code>If HasProperty(handler, "update") is true, then</code> step inside the for-loop as if <code>update</code> property is missing. We should just return the value.</p>
<h4 id="step-5">Step 5</h4>
<p>This line can be kept as it, but in the same way as for the <code>update</code> property, we need to check if it is callable and this should be done at the start to keep the function predictable. But this gives us a new problem, since the <code>insert</code> property should also be optional. To solve this one we would probably need to change the behaviour of the function, as having a requirement for a developer to call <code>Map.has</code> before using the function in scenarios where only the <code>insert</code> property is missing makes the function very unintuitive to use. There are several ways to solve this, and this is something that would be worked out through discussions with other committee members and consulting with JavaScript developers. Two example solutions could be:</p>
<ol type="1">
<li>Change the proposal such that the <code>insert</code> property is required and throw an error when it is missing.</li>
<li>Let the <code>insert</code> property be optional, but change the behaviour to be like <code>Map.get</code> and return undefined if the key is not in the map and the <code>insert</code> property isn’t provided.</li>
</ol>
<p>As, this proposal have already changed significantly and this is no longer an issue. We will go with the second option for demonstration purposes.</p>
<h4 id="step-6-8">Step 6-8</h4>
<p>These steps are similar to <code>4.a.i.1-4.a.i.3</code> and only need some rewriting to keep them consistent.</p>
<p>With all this is mind, we can now rewrite the specification.</p>
<h3 id="map.prototype.upsert-key-handler">Map.prototype.upsert ( key, handler )</h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1.</span> <span class="va">Let</span> <span class="cn">M</span> <span class="va">be</span> <span class="va">the</span> <span class="va">this</span> <span class="va">value</span><span class="op">.</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="dv">3.</span> <span class="va">Set</span> <span class="va">key</span> <span class="va">to</span> CanonicalizeKeyedCollectionKey<span class="op">(</span><span class="va">key</span><span class="op">).</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">Let</span> <span class="va">insertfn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">).</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">b</span><span class="op">.</span> <span class="va">If</span> IsCallable<span class="op">(</span><span class="va">insertfn</span><span class="op">)</span> <span class="va">is</span> <span class="kw">false</span><span class="op">,</span> <span class="va">throw</span> <span class="va">a</span> <span class="va">TypeError</span> <span class="va">exception</span><span class="op">.</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="dv">5.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">Let</span> <span class="va">updatefn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">).</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">b</span><span class="op">.</span> <span class="va">If</span> IsCallable<span class="op">(</span><span class="va">updatefn</span><span class="op">)</span> <span class="va">is</span> <span class="kw">false</span><span class="op">,</span> <span class="va">throw</span> <span class="va">a</span> <span class="va">TypeError</span> <span class="va">exception</span><span class="op">.</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="dv">6.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">p</span> <span class="va">of</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">,</span> <span class="cf">do</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">If</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Key]]</span> <span class="va">is</span> <span class="kw">not</span> <span class="va">empty</span> <span class="kw">and</span> SameValue<span class="op">(</span><span class="va">p</span><span class="op">.</span><span class="vs">[[Key]]</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">i</span><span class="op">.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1.</span> <span class="va">Let</span> <span class="va">updatefn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">).</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>      <span class="dv">2.</span> <span class="va">Let</span> <span class="va">updated</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">updatefn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>      <span class="dv">3.</span> <span class="va">Set</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span> <span class="va">to</span> <span class="va">updated</span><span class="op">.</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>   <span class="va">ii</span><span class="op">.</span> <span class="va">Return</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="dv">7.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">Let</span> <span class="va">insertfn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">).</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">b</span><span class="op">.</span> <span class="va">Let</span> <span class="va">inserted</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">insertfn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">c</span><span class="op">.</span> <span class="va">Let</span> <span class="va">p</span> <span class="va">be</span> <span class="va">the</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">:</span> <span class="va">key</span><span class="op">,</span> <span class="vs">[[Value]]</span><span class="op">:</span> <span class="va">inserted</span> <span class="op">}.</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="va">d</span><span class="op">.</span> <span class="va">Append</span> <span class="va">p</span> <span class="va">to</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">.</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="va">e</span><span class="op">.</span> <span class="va">Return</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="dv">8.</span> <span class="va">Return</span> <span class="va">undefined</span><span class="op">.</span></span></code></pre></div>
<h3 id="weakmap.prototype.upsert-key-handler">WeakMap.prototype.upsert ( key, handler)</h3>
<p>The <code>WeakMap</code> specification is very similar to the normal <code>Map</code> implementation, but there is one crucial difference. Since <code>WeakMap</code> is a different kind of map, there are also a different requirement for the <code>key</code>. We won’t go into specifics about the difference, but instead of normalising the <code>key</code> with <code>CanonicalizeKeyedCollectionKey</code>, we instead need to do a check for if the key can be held <code>weakly</code>.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1.</span> <span class="va">Let</span> <span class="cn">M</span> <span class="va">be</span> <span class="va">the</span> <span class="va">this</span> <span class="va">value</span><span class="op">.</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="dv">3.</span> <span class="va">If</span> CanBeHeldWeakly<span class="op">(</span><span class="va">key</span><span class="op">)</span> <span class="va">is</span> <span class="kw">false</span><span class="op">,</span> <span class="va">throw</span> <span class="va">a</span> <span class="va">TypeError</span> <span class="va">exception</span><span class="op">.</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">Let</span> <span class="va">insertfn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">).</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">b</span><span class="op">.</span> <span class="va">If</span> IsCallable<span class="op">(</span><span class="va">insertfn</span><span class="op">)</span> <span class="va">is</span> <span class="kw">false</span><span class="op">,</span> <span class="va">throw</span> <span class="va">a</span> <span class="va">TypeError</span> <span class="va">exception</span><span class="op">.</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="dv">5.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">Let</span> <span class="va">updatefn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">).</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">b</span><span class="op">.</span> <span class="va">If</span> IsCallable<span class="op">(</span><span class="va">updatefn</span><span class="op">)</span> <span class="va">is</span> <span class="kw">false</span><span class="op">,</span> <span class="va">throw</span> <span class="va">a</span> <span class="va">TypeError</span> <span class="va">exception</span><span class="op">.</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="dv">6.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">p</span> <span class="va">of</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">,</span> <span class="cf">do</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">If</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Key]]</span> <span class="va">is</span> <span class="kw">not</span> <span class="va">empty</span> <span class="kw">and</span> SameValue<span class="op">(</span><span class="va">p</span><span class="op">.</span><span class="vs">[[Key]]</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">i</span><span class="op">.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1.</span> <span class="va">Let</span> <span class="va">updatefn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;update&quot;</span><span class="op">).</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>      <span class="dv">2.</span> <span class="va">Let</span> <span class="va">updated</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">updatefn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>      <span class="dv">3.</span> <span class="va">Set</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span> <span class="va">to</span> <span class="va">updated</span><span class="op">.</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>   <span class="va">ii</span><span class="op">.</span> <span class="va">Return</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="dv">7.</span> <span class="va">If</span> HasProperty<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">then</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">a</span><span class="op">.</span> <span class="va">Let</span> <span class="va">insertfn</span> <span class="va">be</span> ? Get<span class="op">(</span><span class="va">handler</span><span class="op">,</span> <span class="st">&quot;insert&quot;</span><span class="op">).</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">b</span><span class="op">.</span> <span class="va">Let</span> <span class="va">inserted</span> <span class="va">be</span> ? Call<span class="op">(</span><span class="va">insertfn</span><span class="op">,</span> <span class="va">handler</span><span class="op">,</span> « <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">,</span> <span class="va">key</span><span class="op">,</span> <span class="cn">M</span> »<span class="op">).</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">c</span><span class="op">.</span> <span class="va">Let</span> <span class="va">p</span> <span class="va">be</span> <span class="va">the</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">:</span> <span class="va">key</span><span class="op">,</span> <span class="vs">[[Value]]</span><span class="op">:</span> <span class="va">inserted</span> <span class="op">}.</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>  <span class="va">d</span><span class="op">.</span> <span class="va">Append</span> <span class="va">p</span> <span class="va">to</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">.</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>  <span class="va">e</span><span class="op">.</span> <span class="va">Return</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="dv">8.</span> <span class="va">Return</span> <span class="va">undefined</span><span class="op">.</span></span></code></pre></div>
<h3 id="is-everything-fixed-now">Is everything fixed now?</h3>
<p>In it’s current state everything should work, but there are some scenarios that hasn’t been discussed yet and might change how the proposal behaves. For example, what should one do if the either the <code>updatefn</code> or <code>insertfn</code> mutates the map?
More specifically, if the <code>updatefn</code> overwrites the key we are about to set, should we; overwrite this value, skip overwriting it, or maybe even throw an error?
And what if the <code>insertfn</code> inserts a value on the key in the map, should we; rerun the algorithm and update this value, overwrite the value, skip overwriting the value, or throw an error?</p>
<p>I will leave these scenarios up to the reader to discuss and think about since there might not be a right or wrong answer.</p>
</details>
<details open>
<summary class="h2">
Redesigning the Proposal
</summary>
<p>As we already alluded, a common problem when using a <code>Map</code> is how to handle doing a <code>Map</code> entry when you’re not sure if the <code>key</code> already exists in the <code>Map</code>.
This can be handled by first checking if the <code>key</code> is present, and then inserting or updating depending upon the result. However, this is both inconvenient for the developer, and far from being optimal - because it requires multiple lookups in the <code>Map</code> that could otherwise be handled in a single call.</p>
<p>A possible solution for this is to have a method with the following behaviour: it will check whether the given <code>key</code> already exists in the <code>Map</code>, and, if the <code>key</code> already exists, the <code>value</code> associated with the <code>key</code> will be returned. Otherwise, the new <code>key</code>-<code>value</code> pair will be inserted into the <code>Map</code>, before returning the newly input <code>value</code>.</p>
<p>Togheter with this redesign of the proposal, we will also change the name of the method to <code>getOrInsert</code>. This means that we must change the name of the hook we created earlier.</p>
<p>Let’s look at an example of how the new method <code>getOrInsert</code> can be used.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ECMAScript 15.0 - without using the `upsert` proposal</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> prefs <span class="op">=</span> <span class="kw">new</span> <span class="fu">getUserPrefs</span>()<span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (prefs<span class="op">.</span><span class="fu">has</span>(<span class="st">&quot;useDarkmode&quot;</span>)) {</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> darkMode <span class="op">=</span> prefs<span class="op">.</span><span class="fu">get</span>(<span class="st">&quot;useDarkmode&quot;</span>)<span class="op">;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  prefs<span class="op">.</span><span class="fu">set</span>(<span class="st">&quot;useDarkmode&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  darkMode <span class="op">=</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// `true` is the default value</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co">// using the new design of the `upsert` proposal</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> prefs <span class="op">=</span> <span class="kw">new</span> <span class="fu">getUserPrefs</span>()<span class="op">;</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>prefs<span class="op">.</span><span class="fu">getOrInsert</span>(<span class="st">&quot;useDarkmode&quot;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="co">// defaults to `true`</span></span></code></pre></div>
<p>By using <code>getOrInsert</code>, default values can be applied at different times, with the assurance that later defaults will not overwrite an existing <code>value</code>. This is so because the <code>key</code> would already exist and calling <code>getOrInsert</code> will return the existing <code>key</code> instead of inserting or overwriting.</p>
<p>We can compare this new behaviour of the <code>getOrInsert</code> method with the Python’s <code>setDefault</code> method on dictionaries.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># without using `setdefault`</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>prefs <span class="op">=</span> {}</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">&quot;useDarkmode&quot;</span> <span class="kw">not</span> <span class="kw">in</span> prefs :</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  prefs[<span class="st">&quot;useDarkmode&quot;</span>] <span class="op">=</span> <span class="va">True</span> <span class="co"># `True` is the default value</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>dark_mode <span class="op">=</span> prefs[<span class="st">&quot;useDarkmode&quot;</span>]</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># using `setdefault`</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>prefs <span class="op">=</span> {}</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>prefs.setdefault(<span class="st">&quot;useDarkmode&quot;</span>, <span class="va">True</span>) <span class="co"># defaults to `True`</span></span></code></pre></div>
<p>In the <a href="https://bldl.github.io/upsert-tutorial/key-value-callback-spec/keyValueSpec.html">new version</a> of the <code>upsert</code> proposal, we will consider two different methods:</p>
<ul>
<li><code>getOrInsert</code>: taking arguments <code>key</code> and <code>value</code></li>
<li><code>getOrInsertComputed</code>: taking arguments <code>key</code> and <code>callbackfn</code></li>
</ul>
<p>Both versions serve the same principle as a <code>get</code> or <code>insert</code>-if-missing method on the <code>MapObject</code>. The different signatures offer more flexibility to the developer. The <code>value</code> version is simple and works for most use-cases, while the <code>callbackfn</code> version offers more versatility and could for example be used to compute a conditional insert-value.</p>
<p>For the remainder of this tutorial, we will focus on the <code>getOrInsert(key, value)</code> method. But we will also show the implementation for <code>getOrInsertComputed(key, callbackfn)</code> at the end.</p>
<p>To implement the new proposal, we first need to adapt the specification.</p>
<h2 id="drafting-the-new-specification-of-the-proposal">Drafting the New Specification of the Proposal</h2>
<p>The new specification draws from the original specification and adapts to the newly specified behaviour we described above.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1.</span> <span class="va">Let</span> <span class="cn">M</span> <span class="va">be</span> <span class="va">the</span> <span class="va">this</span> <span class="va">value</span><span class="op">.</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="dv">3.</span> <span class="va">Set</span> <span class="va">key</span> <span class="va">to</span> CanonicalizeKeyedCollectionKey<span class="op">(</span><span class="va">key</span><span class="op">).</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">p</span> <span class="va">of</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">,</span> <span class="cf">do</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span><span class="er">a</span><span class="op">.</span> <span class="va">If</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Key]]</span> <span class="va">is</span> <span class="kw">not</span> <span class="va">empty</span> <span class="kw">and</span> SameValue<span class="op">(</span><span class="va">p</span><span class="op">.</span><span class="vs">[[Key]]</span><span class="op">,</span> <span class="va">_key_</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">return</span> <span class="va">p</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="dv">5.</span> <span class="va">Let</span> <span class="va">p</span> <span class="va">be</span> <span class="va">the</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">:</span> <span class="va">key</span><span class="op">,</span> <span class="vs">[[Value]]</span><span class="op">:</span> <span class="va">value</span> <span class="op">}.</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="dv">6.</span> <span class="va">Append</span> <span class="va">p</span> <span class="va">to</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">.</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="dv">7.</span> <span class="va">Return</span> <span class="va">value</span><span class="op">.</span></span></code></pre></div>
<p>An HTML version of the specification can be found <a href="https://bldl.github.io/upsert-tutorial/key-value-callback-spec/Map.prototype.getOrInsert.html">here</a>.</p>
</details>
<details open>
<summary class="h1">
Implementing the new proposal
</summary>
<p>We will now implement this new proposal similarly to how we implemented the previous one.
Since this is a new function with a different name, we need to start of with;</p>
<ol type="1">
<li>Create a new torque file in <code>/src/builtins</code>.</li>
<li>Declare the new file in <code>BUILD.gn</code>.</li>
<li>Declare the function in the new file.</li>
<li>Hook the function into v8 in <code>bootstrapper.cc</code>.</li>
</ol>
<p>These steps are the same as we did for <code>upsert</code>, and these steps can also be followed here by simply changing the names.</p>
<h3 id="step-1-4---the-logic-remains-mostly-the-same">Step 1-4 - The logic remains mostly the same</h3>
<p>For the changed proposal, the first steps of the specification remains mostly the same. Except for some small changes that were made to make the specification text similar to other functions.<br />
Step 3 has been removed and replaced with:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dv">3.</span> <span class="va">Set</span> <span class="va">key</span> <span class="va">to</span> CanonicalizeKeyedCollectionKey<span class="op">(</span><span class="va">key</span><span class="op">).</span></span></code></pre></div>
<p>Step 4 has been rewritten to:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">p</span> <span class="va">of</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">,</span> <span class="cf">do</span></span></code></pre></div>
<p>This doesn’t change our implementation that much and we can reuse most of our previous implementation.</p>
<p>Implement the first four lines of the proposal.<br />
<strong>Specification Lines:</strong></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1.</span> <span class="va">Let</span> <span class="cn">M</span> <span class="va">be</span> <span class="va">the</span> <span class="va">this</span> <span class="va">value</span><span class="op">.</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="dv">3.</span> <span class="va">Set</span> <span class="va">key</span> <span class="va">to</span> CanonicalizeKeyedCollectionKey<span class="op">(</span><span class="va">key</span><span class="op">).</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">p</span> <span class="va">of</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">,</span> <span class="cf">do</span></span></code></pre></div>
<p>In the following way.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeGetOrInsert</span>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(key<span class="op">:</span> JSAny<span class="op">,</span> value<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.getOrInsert'</span><span class="op">;</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ThrowTypeError</span>(</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>      MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Set key to CanonicalizeKeyedCollectionKey(key).</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> key <span class="op">=</span> <span class="fu">NormalizeNumberKey</span>(key)<span class="op">;</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } p of M.[[MapData]], do</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> iter <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> p <span class="op">=</span> iter<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">//...</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="step-4.a-if-the-key-exists-return-the-value">Step 4.a If the key exists, return the value</h3>
<p>This step is almost exactly the same as our previous implementation, so it doesn’t need much alteration except for returning the found value instead of updating.</p>
<p><strong>Specification Line:</strong></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span><span class="er">a</span><span class="op">.</span> <span class="va">If</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Key]]</span> <span class="va">is</span> <span class="kw">not</span> <span class="va">empty</span> <span class="kw">and</span> SameValue<span class="op">(</span><span class="va">e</span><span class="op">.</span><span class="vs">[[Key]]</span><span class="op">,</span> <span class="va">key</span><span class="op">)</span> <span class="va">is</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">return</span> <span class="va">e</span><span class="op">.</span><span class="vs">[[Value]]</span><span class="op">.</span></span></code></pre></div>
<p>Since we now normalise the key in step <code>3</code> we don’t need to do it on every iteration now and the nested if-statements have been replaced with a simple return statement.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeGetOrInsert</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(key<span class="op">:</span> JSAny<span class="op">,</span> value<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.getOrInsert'</span><span class="op">;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ThrowTypeError</span>(</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Set key to CanonicalizeKeyedCollectionKey(key).</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> key <span class="op">=</span> <span class="fu">NormalizeNumberKey</span>(key)<span class="op">;</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } p of M.[[MapData]], do</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> iter <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> p <span class="op">=</span> iter<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValue(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(p<span class="op">.</span><span class="at">key</span><span class="op">,</span> key)) {</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> p<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="step-5-7---insert-the-new-key-value-pair-and-return-the-value">Step 5-7 - Insert the new key value pair and return the value</h3>
<p>The last steps handles the scenario where the key doesn’t exists in the map.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dv">5.</span> <span class="va">Let</span> <span class="va">p</span> <span class="va">be</span> <span class="va">the</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">:</span> <span class="va">key</span><span class="op">,</span> <span class="vs">[[Value]]</span><span class="op">:</span> <span class="va">value</span> <span class="op">}.</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="dv">6.</span> <span class="va">Append</span> <span class="va">p</span> <span class="va">to</span> <span class="cn">M</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">.</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="dv">7.</span> <span class="va">Return</span> <span class="va">value</span><span class="op">.</span></span></code></pre></div>
<p>The specification text is three steps, but broken down it is simply to insert a new key-value pair in the map and return the <code>value</code> argument.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeGetOrInsert</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(key<span class="op">:</span> JSAny<span class="op">,</span> value<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.getOrInsert'</span><span class="op">;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ThrowTypeError</span>(</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>      MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Set key to CanonicalizeKeyedCollectionKey(key).</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  key <span class="op">=</span> <span class="fu">NormalizeNumberKey</span>(key)<span class="op">;</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. For each Record { [[Key]], [[Value]] } p of M.[[MapData]], do</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">;</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> iter <span class="op">=</span> <span class="fu">NewUnmodifiedOrderedHashMapIterator</span>(table<span class="op">.</span><span class="fu">GetTable</span>())<span class="op">;</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> p <span class="op">=</span> iter<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  a. If e.[[Key]] is not empty and SameValue(e.[[Key]], key) is true, return e.[[Value]].</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">TaggedEqual</span>(p<span class="op">.</span><span class="at">key</span><span class="op">,</span> key)) {</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> p<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  } label Done {}</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 5. Let p be the Record { [[Key]]: key, [[Value]]: value }.</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 6. Append p to M.[[MapData]].</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MapSet</span>(m<span class="op">,</span> key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 7. Return value.</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
<details open>
<summary class="h2">
Optimization
</summary>
<p>As the specification text only specifies the functionality and behaviour of a feature. The implementation doesn’t have to follow the algorithm in the specification as long as the obeserved behaviour is kept the same. This allows us to optimise the implementation if we wish, and in this proposal there are several optimisation that we can do.</p>
<p>The most obvious one is line 4 in the specification:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dv">4.</span> <span class="va">For</span> <span class="va">each</span> Record <span class="op">{</span> <span class="vs">[[Key]]</span><span class="op">,</span> <span class="vs">[[Value]]</span> <span class="op">}</span> <span class="va">_p_</span> <span class="va">of</span> <span class="cn">_M_</span><span class="op">.</span><span class="vs">[[MapData]]</span><span class="op">,</span> <span class="cf">do</span></span></code></pre></div>
<p>Which is currently implemented as:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p <span class="op">=</span> iter<span class="op">.</span><span class="fu">Next</span>() otherwise Done<span class="op">;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The worst case running time of this is <code>O(n)</code> as it will have to loop through the whole table to check if an entry exists.
This should be easily optimizable to be a <code>O(1)</code>, given an efficient <code>HashTable</code> implementation, without changing the behaviour of the feature.</p>
<p>The most obvious solution is to change the for-loop for a simple <code>map.has</code> lookup instead, and then use a <code>map.get</code> to retrieve the value if it exists or insert the value if it doesn’t exist.</p>
<p>Now, we can either choose to expose the <code>map.has</code> in a similar fashion as we did with ?<code>MapSet</code>, or use the <code>table.HasKey()</code> that is already defined for <code>StableOrderedHashMap</code>.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> table <span class="op">=</span> <span class="fu">NewStableBackingTableWitness</span>(m)<span class="op">.</span><span class="fu">GetTable</span>()<span class="op">;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (table<span class="op">.</span><span class="fu">HasKey</span>(key)) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">GetValue</span>(m<span class="op">,</span> key)<span class="op">;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="can-we-optimize-even-more">Can we optimize even more?</h2>
<p>Yes. If we look at <code>HasKey</code>, <code>GetValue</code> and <code>MapSet</code>, we can see that we have to lookup the key several times and in <code>MapSet</code> we have to take into account that we might overwrite an existing entry when inserting the new value. What we can do here is optimise away several key lookups, and if we are inserting a value, we already know that it will be a new entry.</p>
<h3 id="about-code-stub-assembler">About Code Stub Assembler</h3>
<p>Before we can go ahead and write our optimised function, we first have to talk CSA (Code Stub Assembler). As already mentioned, CSA is a domain specific language to v8 and the predecessor to torque. It gives an implementer higher abstraction than handwriting assembly instructions, while also have a high degree of control of the program flow. This means that the language can be very verbose, even for relatively simple things.</p>
<p>While looking at some of the CSA code from before, you have probably notices that it doesn’t use if- and else-statements to control the program flow. Instead CSA makes use of labels instead, you can look at labels sort of like a switch-statement where:<br />
<code>Goto</code>, <code>GotoIf</code> and <code>Branch</code> is the switch and <code>BIND</code> is the different cases.<br />
Another thing to make notice of is that CSA doesn’t use most variables in a way that is familiar to most people.
We can declare new variables with <code>TVARIABLE</code> with the following parameters:</p>
<ul>
<li>Type</li>
<li>Identifier</li>
<li>Initial value<span class="math inline"><sub><em>o</em><em>p</em><em>t</em><em>i</em><em>o</em><em>n</em><em>a</em><em>l</em></sub></span></li>
</ul>
<p>Now that we have some basic understanding of CSA, we can implement our function that will either get or add an entry to the map.</p>
<p>First we declare the <code>MapGetOrAdd</code> function in <code>builtins-collections-gen.h</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> MapGetOrAdd<span class="op">(</span><span class="at">const</span> TNode<span class="op">&lt;</span>Context<span class="op">&gt;</span> context<span class="op">,</span> TNode<span class="op">&lt;</span>JSMap<span class="op">&gt;</span> receiver<span class="op">,</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>                         TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> key<span class="op">,</span> TNode<span class="op">&lt;</span>Object<span class="op">&gt;</span> value<span class="op">);</span></span></code></pre></div>
<p>Write a <code>MapGetOrAdd</code> function in <code>builtins-collections-gen.cc</code>. Here you should take some inspiration from the three functions mentioned above, but most the function will be very similar to the <code>AddToOrderedHashTable</code> that can be found in the same file.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> CollectionsBuiltinsAssembler<span class="op">::</span>MapGetOrAdd<span class="op">(</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>Context<span class="op">&gt;</span> context<span class="op">,</span> TNode<span class="op">&lt;</span>JSMap<span class="op">&gt;</span> receiver<span class="op">,</span> TNode<span class="op">&lt;</span>JSAny<span class="op">&gt;</span> key<span class="op">,</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    TNode<span class="op">&lt;</span>Object<span class="op">&gt;</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  TVARIABLE<span class="op">(</span>IntPtrT<span class="op">,</span> entry_start_position_or_hash<span class="op">,</span> IntPtrConstant<span class="op">(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  TVARIABLE<span class="op">(</span>Object<span class="op">,</span> result<span class="op">);</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  Label if_found<span class="op">(</span><span class="kw">this</span><span class="op">),</span> if_not_found<span class="op">(</span><span class="kw">this</span><span class="op">),</span> done<span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table <span class="op">=</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>      LoadObjectField<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;(</span>receiver<span class="op">,</span> JSMap<span class="op">::</span>kTableOffset<span class="op">);</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  TryLookupOrderedHashTableIndex<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;(</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>      table<span class="op">,</span> key<span class="op">,</span> <span class="op">&amp;</span>entry_start_position_or_hash<span class="op">,</span> <span class="op">&amp;</span>if_found<span class="op">,</span> <span class="op">&amp;</span>if_not_found<span class="op">);</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>if_found<span class="op">);</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> LoadValueFromOrderedHashMapEntry<span class="op">(</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>        table<span class="op">,</span> entry_start_position_or_hash<span class="op">.</span>value<span class="op">());</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    Goto<span class="op">(&amp;</span>done<span class="op">);</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>  Label add_entry<span class="op">(</span><span class="kw">this</span><span class="op">),</span> store_new_entry<span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>if_not_found<span class="op">);</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If we have a hash code, we can start adding the new entry.</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    GotoIf<span class="op">(</span>IntPtrGreaterThan<span class="op">(</span>entry_start_position_or_hash<span class="op">.</span>value<span class="op">(),</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>                             IntPtrConstant<span class="op">(</span><span class="dv">0</span><span class="op">)),</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>           <span class="op">&amp;</span>add_entry<span class="op">);</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Otherwise, go to runtime to compute the hash code.</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>    entry_start_position_or_hash <span class="op">=</span> SmiUntag<span class="op">(</span>CallGetOrCreateHashRaw<span class="op">(</span>CAST<span class="op">(</span>key<span class="op">)));</span></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>    Goto<span class="op">(&amp;</span>add_entry<span class="op">);</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>add_entry<span class="op">);</span></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>  TVARIABLE<span class="op">(</span>OrderedHashMap<span class="op">,</span> table_var<span class="op">,</span> table<span class="op">);</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>  TVARIABLE<span class="op">(</span>IntPtrT<span class="op">,</span> number_of_buckets<span class="op">);</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>  TVARIABLE<span class="op">(</span>IntPtrT<span class="op">,</span> occupancy<span class="op">);</span></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>    GrowCollection<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> grow <span class="op">=</span> <span class="op">[</span><span class="kw">this</span><span class="op">,</span> context<span class="op">,</span> receiver<span class="op">]()</span> <span class="op">{</span></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>      CallRuntime<span class="op">(</span>Runtime<span class="op">::</span>kMapGrow<span class="op">,</span> context<span class="op">,</span> receiver<span class="op">);</span></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> LoadObjectField<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;(</span>receiver<span class="op">,</span> JSMap<span class="op">::</span>kTableOffset<span class="op">);</span></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>    number_of_buckets <span class="op">=</span> PositiveSmiUntag<span class="op">(</span>CAST<span class="op">(</span>UnsafeLoadFixedArrayElement<span class="op">(</span></span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>        table<span class="op">,</span> OrderedHashMap<span class="op">::</span>NumberOfBucketsIndex<span class="op">())));</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static_assert</span><span class="op">(</span>OrderedHashMap<span class="op">::</span>kLoadFactor <span class="op">==</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>WordT<span class="op">&gt;</span> capacity <span class="op">=</span> WordShl<span class="op">(</span>number_of_buckets<span class="op">.</span>value<span class="op">(),</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> number_of_elements <span class="op">=</span></span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a>        LoadAndUntagPositiveSmiObjectField<span class="op">(</span></span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>            table<span class="op">,</span> OrderedHashMap<span class="op">::</span>NumberOfElementsOffset<span class="op">());</span></span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> number_of_deleted <span class="op">=</span></span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>        PositiveSmiUntag<span class="op">(</span>CAST<span class="op">(</span>LoadObjectField<span class="op">(</span></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a>            table<span class="op">,</span> OrderedHashMap<span class="op">::</span>NumberOfDeletedElementsOffset<span class="op">())));</span></span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a>    occupancy <span class="op">=</span> IntPtrAdd<span class="op">(</span>number_of_elements<span class="op">,</span> number_of_deleted<span class="op">);</span></span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a>    GotoIf<span class="op">(</span>IntPtrLessThan<span class="op">(</span>occupancy<span class="op">.</span>value<span class="op">(),</span> capacity<span class="op">),</span> <span class="op">&amp;</span>store_new_entry<span class="op">);</span></span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// We do not have enough space, grow the table and reload the relevant</span></span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// fields.</span></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a>    table_var <span class="op">=</span> grow<span class="op">();</span></span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a>    number_of_buckets <span class="op">=</span> PositiveSmiUntag<span class="op">(</span>CAST<span class="op">(</span>UnsafeLoadFixedArrayElement<span class="op">(</span></span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a>        table_var<span class="op">.</span>value<span class="op">(),</span> OrderedHashMap<span class="op">::</span>NumberOfBucketsIndex<span class="op">())));</span></span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> new_number_of_elements <span class="op">=</span></span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a>        LoadAndUntagPositiveSmiObjectField<span class="op">(</span></span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a>            table_var<span class="op">.</span>value<span class="op">(),</span> OrderedHashMap<span class="op">::</span>NumberOfElementsOffset<span class="op">());</span></span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> new_number_of_deleted <span class="op">=</span> PositiveSmiUntag<span class="op">(</span></span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a>        CAST<span class="op">(</span>LoadObjectField<span class="op">(</span>table_var<span class="op">.</span>value<span class="op">(),</span></span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>                             OrderedHashMap<span class="op">::</span>NumberOfDeletedElementsOffset<span class="op">())));</span></span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a>    occupancy <span class="op">=</span> IntPtrAdd<span class="op">(</span>new_number_of_elements<span class="op">,</span> new_number_of_deleted<span class="op">);</span></span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a>    Goto<span class="op">(&amp;</span>store_new_entry<span class="op">);</span></span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>store_new_entry<span class="op">);</span></span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a>    StoreAtEntry<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> store_at_new_entry <span class="op">=</span></span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="kw">this</span><span class="op">,</span> key<span class="op">,</span> value<span class="op">](</span><span class="at">const</span> TNode<span class="op">&lt;</span>OrderedHashMap<span class="op">&gt;</span> table<span class="op">,</span></span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a>                           <span class="at">const</span> TNode<span class="op">&lt;</span>IntPtrT<span class="op">&gt;</span> entry_start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true" tabindex="-1"></a>          UnsafeStoreKeyValueInOrderedHashMapEntry<span class="op">(</span>table<span class="op">,</span> key<span class="op">,</span> value<span class="op">,</span></span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true" tabindex="-1"></a>                                                   entry_start<span class="op">);</span></span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true" tabindex="-1"></a>    StoreOrderedHashTableNewEntry<span class="op">(</span></span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true" tabindex="-1"></a>        table_var<span class="op">.</span>value<span class="op">(),</span> entry_start_position_or_hash<span class="op">.</span>value<span class="op">(),</span></span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true" tabindex="-1"></a>        number_of_buckets<span class="op">.</span>value<span class="op">(),</span> occupancy<span class="op">.</span>value<span class="op">(),</span> store_at_new_entry<span class="op">);</span></span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true" tabindex="-1"></a>    Goto<span class="op">(&amp;</span>done<span class="op">);</span></span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true" tabindex="-1"></a>  BIND<span class="op">(&amp;</span>done<span class="op">);</span></span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> CAST<span class="op">(</span>result<span class="op">.</span>value<span class="op">());</span></span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>After implementing this, we can finally write our little bit of torque code.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">collections</span> {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>extern macro CollectionsBuiltinsAssembler<span class="op">::</span><span class="fu">MapGetOrAdd</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    implicit context<span class="op">:</span> Context)(JSMap<span class="op">,</span> JSAny<span class="op">,</span> <span class="bu">Object</span>)<span class="op">:</span> JSAny<span class="op">;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>transitioning javascript builtin <span class="fu">MapPrototypeGetOrInsert</span>(</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    js<span class="op">-</span>implicit context<span class="op">:</span> NativeContext<span class="op">,</span> receiver<span class="op">:</span> JSAny)(key<span class="op">:</span> JSAny<span class="op">,</span> value<span class="op">:</span> JSAny)<span class="op">:</span> JSAny {</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> methodName<span class="op">:</span> constexpr <span class="dt">string</span> <span class="op">=</span> <span class="st">'Map.prototype.getOrInsert'</span><span class="op">;</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Let M be the this value.</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Perform ? RequireInternalSlot(M, [[MapData]]).</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m <span class="op">=</span> <span class="fu">Cast</span><span class="op">&lt;</span>JSMap<span class="op">&gt;</span>(receiver) otherwise</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ThrowTypeError</span>(</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>      MessageTemplate<span class="op">::</span>kIncompatibleMethodReceiver<span class="op">,</span> methodName<span class="op">,</span> receiver)<span class="op">;</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Set key to CanonicalizeKeyedCollectionKey(key).</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">MapGetOrAdd</span>(m<span class="op">,</span> key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
<details open>
<summary class="h1">
Testing with Test262
</summary>
<h3 id="writing-tests-for-test262">Writing tests for <a href="https://github.com/tc39/test262">Test262</a></h3>
<p>When it comes to testing implementations, there are some guidelines to follow.
The <a href="https://github.com/tc39/test262/blob/main/CONTRIBUTING.md#acceptable-tests">official guidelines</a> state that an acceptable test in Test262 is the following:</p>
<blockquote>
<p><em>Any test that exercises observable grammar or semantics, originating with citable, normative text in the latest draft of the ECMAScript® Language Specification, the ECMAScript® Internationalization API Specification, the The JSON Data Interchange Syntax, a Stage 3 proposal or a Pull Request which makes a normative change to any of those specifications.</em></p>
</blockquote>
<p>The key point for this is that we should write tests for any observable grammar or semantic from our specification.</p>
<p>First, we need to identify the so-called <em>testable lines</em> in our specification.
One way to think about it is this: whenever the behaviour of the specification is observable to the user, then it is testable.</p>
<p>An example of an easily testable line in our specification is:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2.</span> <span class="va">Perform</span> ? RequireInternalSlot<span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="vs">[[MapData]]</span><span class="op">).</span></span></code></pre></div>
<p>Recall that this line, among other things, checks whether <code>this</code> is an <code>Object</code>. Therefore, we can test it by trying it on non-objects, for example, on <a href="https://262.ecma-international.org/#sec-primitive-value">values of primitive types</a>.
Here is an example of a test where we assert that calling the <code>getOrInsert</code> method on <code>false</code> with arguments <code>1</code> and <code>1</code> will throw <code>TypeError</code> exception:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> m <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="kw">false</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>The <code>assert</code> method is a part of the Test262 suite. You can find the rest of the functions for assert <a href="https://github.com/tc39/test262/blob/main/CONTRIBUTING.md#test-environment" target="_blank">here</a>.</p>
<h3 id="more-than-just-testing">More Than Just Testing</h3>
<p>Test262 test should be documented in a <a href="https://github.com/tc39/test262/blob/main/CONTRIBUTING.md#test-case-style">certain manner</a>.</p>
<h4 id="copyrights">Copyrights</h4>
<p>We start with stating the copyright:</p>
<pre><code>// Copyright (C) *Year *Name. All rights reserved.
// This code is governed by the BSD license found in the LICENSE file.</code></pre>
<details>
<summary>
<i>Multiple copyrights holders</i>
</summary>
<p>If there are multiple copyrights holders, they should be listed out with one copyright per line starting with the oldest.
An example of where this is the case, is if the test is written by alternating an exisiting one.</p>
<pre><code>// Copyright (C) *Year *Name. All rights reserved.
// Copyright (C) *Year *Name. All rights reserved.
// This code is governed by the BSD license found in the LICENSE file.</code></pre>
</details>
<h4 id="keys">Keys</h4>
<p>The rest of the test meta-information is enclosed in a YAML string and mentions specific keys, some of which we explain in the table below.
The complete list of possible keys can be found <a href="https://github.com/tc39/test262/blob/main/CONTRIBUTING.md#frontmatter">here</a>.</p>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 93%" />
</colgroup>
<thead>
<tr>
<th>Key</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>esid</code></td>
<td>Reference to specification section, e.g. <code>sec-well-known-symbols</code></td>
</tr>
<tr>
<td><code>description</code></td>
<td>Short one-line description stating the purpose of the test, e.g., “Throws a TypeError if <code>this</code> is not an object”</td>
</tr>
<tr>
<td><code>info</code></td>
<td>Verbose description of the test mentioning, e.g., what does the method look like, which line of the specification are we testing, etc.</td>
</tr>
<tr>
<td><code>includes</code></td>
<td>list of files in the harness/ directory that will be included in the test environment prior to running the test, e.g. <code>compareArray.js</code> if you are using the <code>assert.compareArray</code> function.</td>
</tr>
<tr>
<td><code>features</code></td>
<td>List of language features that are not directly available to the test, e.g. <code>symbols-as-weakmap-keys</code></td>
</tr>
</tbody>
</table>
<p>An important thing to note about keys are that some of them are required, while some are optional, the required keys can be found in the table below.</p>
<table>
<thead>
<tr>
<th>Key.</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>description</code></td>
<td>Required</td>
</tr>
<tr>
<td><code>esid</code></td>
<td>Required for new tests</td>
</tr>
<tr>
<td><code>features</code></td>
<td>Required for new tests written for new features</td>
</tr>
</tbody>
</table>
<p>For our <code>upsert</code> specification, the required key <code>esid</code> is not applicable yet, as (at the time of writing) the proposal hasn’t gotten one. Therefore, we will use <code>pending</code>.</p>
<pre><code>esid: pending</code></pre>
<p>Next comes the <code>description</code> key. In our case, it will look like this:</p>
<pre><code>description: &gt;
    Throws a TypeError if 'this' is not an object</code></pre>
<p>Although not required, we fill out the <code>info</code> key as well:</p>
<pre><code>info: |
    Map.upsert( key , value )

    1. Let M be the this value.
    2. Perform ? RequireInternalSlot(M, [[MapData]]).
    ...</code></pre>
<p>Our full test should now look as follows:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Copyright (C) 2024 Sune Eriksson Lianes. All rights reserved.</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co">// This code is governed by the BSD license found in the LICENSE file.</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*---</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co">esid: proposal-upsert</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co">description: &gt;</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Throws a TypeError if `this` is not an Object.</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co">info: |</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Map.prototype.getOrInsert ( key , value )</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Let M be the this value</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Perform ? RequireInternalSlot(M, [[MapData]])</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ...</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co">---*/</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> m <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="kw">false</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 id="filling-in-test-cases">Filling in Test Cases</h3>
<p>We can now fill in other test cases related to calling <code>getOrInsert</code> on non-objects:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Copyright (C) 2024 Sune Eriksson Lianes. All rights reserved.</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co">// This code is governed by the BSD license found in the LICENSE file.</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*---</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co">esid: proposal-upsert</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">description: &gt;</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Throws a TypeError if `this` is not an Object.</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co">info: |</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Map.prototype.getOrInsert ( key , value )</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Let M be the this value</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Perform ? RequireInternalSlot(M, [[MapData]])</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ...</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="co">features: [Symbol]</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co">---*/</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> m <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="kw">false</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="st">&quot;&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="kw">undefined</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="kw">null</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">throws</span>(<span class="bu">TypeError</span><span class="op">,</span> <span class="kw">function</span> () {</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="at">getOrInsert</span><span class="op">.</span><span class="fu">call</span>(<span class="bu">Symbol</span>()<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>You can take a look at other tests in the <a href="../../tests/test262"><code>test262</code></a> folder or try to write some tests yourself.</p>
<h3 id="running-tests-in-v8">Running Tests in v8</h3>
<p>To add a test, we create a file with the test in <code>test/test262/local-tests/test/built-ins/Map/</code>. It makes sense to create a folder for each function in the proposal that will hold the tests for that specific funciton.</p>
<p>We can run the tests by executing</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tools/dev/gm.py</span> arm64.release test262</span></code></pre></div>
<div class="sourceCode" id="cb76"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[05:09</span><span class="kw">|</span><span class="ex">%</span> 174<span class="kw">|</span><span class="ex">+</span> 94043<span class="kw">|</span><span class="ex">-</span>   0]: Done</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> 53775 <span class="ex">base</span> tests produced 94043 <span class="er">(</span><span class="ex">174%</span><span class="kw">)</span> <span class="ex">non-filtered</span> tests</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> 94043 <span class="ex">tests</span> ran</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Done!</span> <span class="at">-</span> V8 compilation finished successfully.</span></code></pre></div>
</details></section>
</article>

    </main>

    <footer>
        <div class="lhs">
            λ Generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a></br>
            © 2026 Jonas Haukenes
        </div>
        <div class="rhs">
            <button id="theme-toggle" aria-label="Toggle theme">
            <span class="toggle-label">LIGHT</span>
            <span class="toggle-track">
                <span class="toggle-knob"></span>
            </span>
            <span class="toggle-label">DARK</span>
            </button>
        </div>
    </footer>
  </body>
<script>
  (function () {
    const root = document.documentElement;
    const toggle = document.getElementById("theme-toggle");

    // Load saved theme or system preference
    const saved = localStorage.getItem("theme");
    const systemDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

    if (saved) {
      root.setAttribute("data-theme", saved);
    } else {
      root.setAttribute("data-theme", systemDark ? "dark" : "light");
    }

    // Toggle handler
    toggle.addEventListener("click", () => {
      const current = root.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });
  })();
</script>

</html>
